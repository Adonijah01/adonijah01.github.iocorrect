document.addEventListener("DOMContentLoaded", function () {
    const malwareContainer = document.getElementById("malware-list");

    const sources = [
        { name: "MalwareBazaar", url: "https://mb-api.abuse.ch/api/v1/" },
        { name: "ThreatFox", url: "https://threatfox-api.abuse.ch/v1/" }
    ];

    async function fetchMalwareData() {
        try {
            let allMalware = [];

            // Fetch MalwareBazaar data
            let malwareBazaarResponse = await fetch(sources[0].url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ query: "get_recent", limit: 10 })
            });
            let malwareBazaarData = await malwareBazaarResponse.json();
            allMalware = allMalware.concat(malwareBazaarData.data || []);

            // Fetch ThreatFox data
            let threatFoxResponse = await fetch(sources[1].url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ query: "get_recent", limit: 10 })
            });
            let threatFoxData = await threatFoxResponse.json();
            allMalware = allMalware.concat(threatFoxData.data || []);

            // Sort by latest date
            allMalware.sort((a, b) => new Date(b.first_seen) - new Date(a.first_seen));

            // Clear loading text
            malwareContainer.innerHTML = "";

            // Display malware threats (limit to 10)
            allMalware.slice(0, 10).forEach(malware => {
                let malwareItem = document.createElement("div");
                malwareItem.innerHTML = `
                    <h3>${malware.malware_name || "Unknown Malware"}</h3>
                    <p><strong>First Seen:</strong> ${new Date(malware.first_seen).toLocaleDateString()}</p>
                    <p><strong>Hash:</strong> ${malware.sha256 || "N/A"}</p>
                    <p><strong>Threat Type:</strong> ${malware.threat_type || "Unknown"}</p>
                    <p><strong>Description:</strong> ${malware.description || "No details available."}</p>
                    <p><a href="https://bazaar.abuse.ch/sample/${malware.sha256}" target="_blank">View Sample</a></p>
                    <hr>
                `;
                malwareContainer.appendChild(malwareItem);
            });

        } catch (error) {
            console.error("Error fetching malware intelligence:", error);
            malwareContainer.innerHTML = "<p>Failed to load malware intelligence. Please try again later.</p>";
        }
    }

    fetchMalwareData();
});
